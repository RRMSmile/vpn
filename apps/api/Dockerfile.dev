FROM node:20-bookworm

WORKDIR /app

# corepack/pnpm
RUN corepack enable

# копируем манифесты для кеша
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml tsconfig.base.json ./

# workspace packages
COPY packages/shared/package.json packages/shared/package.json
COPY packages/shared/src packages/shared/src

# api package
COPY apps/api/package.json apps/api/package.json
COPY apps/api/tsconfig.json apps/api/tsconfig.json
COPY apps/api/prisma apps/api/prisma

# install deps (внутри контейнера)
# pnpm network hardening + retries (Prisma engines flakes)
RUN pnpm config set fetch-retries 5 \
 && pnpm config set fetch-retry-factor 2 \
 && pnpm config set fetch-retry-mintimeout 20000 \
 && pnpm config set fetch-retry-maxtimeout 120000 \
 && pnpm config set fetch-timeout 600000 \
 && pnpm config set network-concurrency 1

RUN set -e; \
  for i in 1 2 3 4 5; do \
    echo "pnpm install attempt $i/5"; \
    pnpm install --frozen-lockfile && break; \
    code=$?; \
    echo "pnpm install failed (code=$code). sleeping..."; \
    sleep $((i*i*3)); \
  done

RUN pnpm --filter @cloudgate/api prisma generate

# исходники API отдельно (чтобы можно было монтировать их в compose)
COPY apps/api/src apps/api/src

EXPOSE 3001
CMD ["pnpm","--filter","@cloudgate/api","dev"]