# CloudGate VPN: MVP contract

Этот документ фиксирует MVP как продукт и как контракт между:
- API (control plane)
- WireGuard node (data plane)
- клиентом (iOS) и/или ботом

Цель: чтобы любые доработки делались предсказуемо и без "сюрпризов".

## 1) Что пользователь покупает

VPN-доступ по подписке.

MVP-ограничения:
- iOS-only (пока)
- 1 тариф
- 1 подписка = 1 устройство (1 peer WireGuard)
- 1 peer = 1 выделенный IPv4 (/32) внутри VPN-подсети

## 2) Главные сущности (логика)

User
- идентификатор: `userId` (например `tg:1001`)

Device
- принадлежит User
- отражает конкретное устройство (iphone)
- ограничения тарифа применяются на уровне Device

Node
- WireGuard-сервер (wg0)
- хранит serverPublicKey, endpoint, allowed subnets и т.п.

Peer
- принадлежит Device и Node
- содержит pubkey + allowedIp (/32)
- состояние peer определяет фактический доступ

## 3) Источник истины

Источник истины в MVP: БД (Postgres).

WireGuard node исполняет состояние, но не задаёт его.

Правило:
- если Peer есть в БД и он ACTIVE -> он обязан существовать на ноде
- если Peer отсутствует в БД или REVOKED -> его не должно быть на ноде

## 4) Состояния доступа (MVP)

Peer.state:
- ACTIVE: доступ должен работать
- REVOKED: доступ должен быть отключён (peer удалён на ноде)

Device.state (опционально, если уже есть):
- ACTIVE / DISABLED

Subscription state (логика, даже если оплату подключим позже):
- ACTIVE: разрешаем provisioning
- EXPIRED: запрещаем provisioning и отзываем peer
- GRACE: короткое окно после окончания (опционально, на будущее)

## 5) Provision flow (создать/выдать конфиг)

Вход:
- userId
- platform + name (IOS + iphone)

Шаги:
1) API создаёт Device (если нет) или возвращает существующий
2) API проверяет лимиты тарифа (в MVP: 1 устройство)
3) API выбирает Node (в MVP может быть один wg-node-1)
4) API выделяет allowedIp (/32) из пула
5) API создаёт Peer в БД (state=ACTIVE)
6) API применяет на ноде:
   - wg set wg0 peer <pubkey> allowed-ips <allowedIp>/32
7) API возвращает клиенту WG-конфиг (или данные для его генерации)

Критично:
- операции должны быть идемпотентными (повторный запрос не ломает состояние)
- при ошибке применения на ноде: БД не должна оставаться в "как будто применилось"

## 6) Revoke flow (отозвать доступ)

Причины:
- отмена подписки
- окончание срока
- ручной бан/отключение

Шаги:
1) Peer.state -> REVOKED (в БД)
2) применяем на ноде:
   - wg set wg0 peer <pubkey> remove
3) освобождаем IP в пул (в зависимости от реализации пула)

## 7) Обязательные инварианты

1) Один Device не может иметь 2 ACTIVE peers одновременно (в MVP).
2) allowedIp уникален в рамках Node для ACTIVE peers.
3) БД задаёт правду, нода исполняет.

## 8) Набор эндпоинтов (минимум)

MVP минимум:
- POST /v1/devices  (create/get device)
- GET  /v1/devices/:id
- POST /v1/peers/provision  (или device-provision)
- POST /v1/peers/revoke

Примечание:
конкретные пути можно оставить как есть, этот документ про контракт.

## 9) Что НЕ входит в MVP

- мульти-ноды и балансировка по странам
- реферальная система
- полноценный биллинг
- multi-device тарифы
- Android/macOS/Windows клиенты
